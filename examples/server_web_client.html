<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime MLX STT - Web Client</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .primary {
            background: #007bff;
            color: white;
        }
        .primary:hover:not(:disabled) {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
            color: white;
        }
        .danger:hover:not(:disabled) {
            background: #c82333;
        }
        .success {
            background: #28a745;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.recording {
            background: #fff3cd;
            color: #856404;
        }
        #transcription {
            min-height: 200px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            overflow-y: auto;
            max-height: 400px;
        }
        .log {
            font-size: 12px;
            color: #666;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            margin-bottom: 5px;
            font-family: monospace;
        }
        select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¤ Realtime MLX STT - Web Client</h1>
        
        <div class="info">
            <strong>Note:</strong> This is a demonstration client. Make sure the server is running on http://localhost:8000 before using this interface.<br>
            <strong>OpenAI Models:</strong> GPT-4o models require OPENAI_API_KEY environment variable to be set when starting the server.
        </div>

        <div class="section">
            <h2>Server Status</h2>
            <div id="serverStatus" class="status disconnected">Disconnected</div>
            <div class="controls">
                <button id="checkHealth" class="primary">Check Health</button>
                <button id="getProfiles" class="primary">Get Profiles</button>
            </div>
        </div>

        <div class="section">
            <h2>System Control</h2>
            <div class="controls" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div>
                    <label for="modeSelect">Operating Mode:</label>
                    <select id="modeSelect" style="width: 100%;">
                        <option value="continuous">Continuous (Always listening)</option>
                        <option value="vad-triggered" selected>VAD-Triggered (Speech detection)</option>
                        <option value="wake-word">Wake Word ("Jarvis")</option>
                    </select>
                </div>
                <div>
                    <label for="modelSelect">Model:</label>
                    <select id="modelSelect" style="width: 100%;">
                        <option value="whisper-large-v3-turbo">Whisper Large v3 Turbo (MLX)</option>
                        <option value="gpt-4o-transcribe">GPT-4o Transcribe (OpenAI)</option>
                        <option value="gpt-4o-mini-transcribe">GPT-4o Mini Transcribe (OpenAI)</option>
                    </select>
                </div>
                <div>
                    <label for="languageSelect">Language:</label>
                    <select id="languageSelect" style="width: 100%;">
                        <option value="">Auto-detect</option>
                        <option value="no">Norwegian</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="pt">Portuguese</option>
                        <option value="nl">Dutch</option>
                        <option value="pl">Polish</option>
                        <option value="ru">Russian</option>
                        <option value="zh">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                    </select>
                </div>
            </div>
            <div class="controls" style="margin-top: 15px;">
                <button id="startSystem" class="success">Start System</button>
                <button id="stopSystem" class="danger" disabled>Stop System</button>
            </div>
            <div id="transcriptionStatus" class="status disconnected" style="margin-top: 15px;">System Stopped</div>
        </div>

        <div class="section">
            <h2>VAD Configuration</h2>
            <div class="info" style="margin-bottom: 15px;">
                <strong>Note:</strong> VAD settings only apply to "VAD-Triggered" and "Wake Word" modes. They are ignored in "Continuous" mode.
            </div>
            <div class="controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="vadSensitivity">VAD Sensitivity (Overall): <span id="vadValue">0.6</span></label>
                    <input type="range" id="vadSensitivity" min="0" max="1" step="0.1" value="0.6" style="width: 100%;">
                </div>
                <div>
                    <label for="minSpeechDuration">Min Speech Duration: <span id="speechDurValue">0.25</span>s</label>
                    <input type="range" id="minSpeechDuration" min="0.1" max="2" step="0.05" value="0.25" style="width: 100%;">
                </div>
                <div style="grid-column: span 2;">
                    <details>
                        <summary style="cursor: pointer; font-weight: bold;">Advanced VAD Settings</summary>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div>
                                <label for="webrtcAggressiveness">WebRTC Aggressiveness: <span id="webrtcValue">2</span></label>
                                <input type="range" id="webrtcAggressiveness" min="0" max="3" step="1" value="2" style="width: 100%;">
                                <small style="color: #666;">0=Least aggressive, 3=Most aggressive</small>
                            </div>
                            <div>
                                <label for="sileroThreshold">Silero Threshold: <span id="sileroValue">0.6</span></label>
                                <input type="range" id="sileroThreshold" min="0.1" max="0.9" step="0.05" value="0.6" style="width: 100%;">
                                <small style="color: #666;">Higher = More conservative</small>
                            </div>
                            <div>
                                <label for="webrtcThreshold">WebRTC History Threshold: <span id="webrtcHistValue">0.6</span></label>
                                <input type="range" id="webrtcThreshold" min="0.3" max="0.9" step="0.05" value="0.6" style="width: 100%;">
                                <small style="color: #666;">Threshold for WebRTC history buffer</small>
                            </div>
                            <div>
                                <label for="useAdvanced">
                                    <input type="checkbox" id="useAdvanced"> Use individual thresholds
                                </label>
                                <small style="color: #666;">Override overall sensitivity</small>
                            </div>
                            <div style="grid-column: span 2;">
                                <h4 style="margin: 10px 0 5px 0;">Frame Processing Settings</h4>
                            </div>
                            <div>
                                <label for="frameDuration">Frame Duration: <span id="frameDurValue">30</span>ms</label>
                                <select id="frameDuration" style="width: 100%;">
                                    <option value="10">10ms (Low latency)</option>
                                    <option value="20">20ms</option>
                                    <option value="30" selected>30ms (Default)</option>
                                </select>
                                <small style="color: #666;">Audio frame size for WebRTC</small>
                            </div>
                            <div>
                                <label for="speechConfFrames">Speech Confirmation: <span id="speechConfValue">2</span> frames</label>
                                <input type="range" id="speechConfFrames" min="1" max="5" step="1" value="2" style="width: 100%;">
                                <small style="color: #666;">Frames to confirm speech (1-5)</small>
                            </div>
                            <div>
                                <label for="silenceConfFrames">Silence Confirmation: <span id="silenceConfValue">30</span> frames</label>
                                <input type="range" id="silenceConfFrames" min="10" max="60" step="5" value="30" style="width: 100%;">
                                <small style="color: #666;">Frames to confirm silence (10-60)</small>
                            </div>
                            <div>
                                <label for="speechBufferSize">Speech Buffer Size: <span id="speechBufValue">100</span> frames</label>
                                <input type="range" id="speechBufferSize" min="50" max="200" step="10" value="100" style="width: 100%;">
                                <small style="color: #666;">Max speech buffer (50-200)</small>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>WebSocket Connection</h2>
            <div class="controls">
                <button id="connectWS" class="primary">Connect WebSocket</button>
                <button id="disconnectWS" class="danger" disabled>Disconnect</button>
                <button id="simulateAudio" class="primary" disabled>Simulate Audio</button>
            </div>
            <div id="wsStatus" class="status disconnected">Disconnected</div>
        </div>

        <div class="section">
            <h2>Transcription Output</h2>
            <div id="transcription">Transcription will appear here...</div>
        </div>

        <div class="section">
            <h2>Log</h2>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/events';
        
        // State
        let ws = null;
        let isRecording = false;
        
        // DOM elements
        const serverStatus = document.getElementById('serverStatus');
        const transcriptionStatus = document.getElementById('transcriptionStatus');
        const wsStatus = document.getElementById('wsStatus');
        const transcriptionDiv = document.getElementById('transcription');
        const logDiv = document.getElementById('log');
        
        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(logEntry, logDiv.firstChild);
            
            // Keep only last 10 logs
            while (logDiv.children.length > 10) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }
        
        function updateServerStatus(connected) {
            serverStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            serverStatus.textContent = connected ? 'Server Connected' : 'Server Disconnected';
        }
        
        function updateTranscriptionStatus(recording) {
            isRecording = recording;
            transcriptionStatus.className = `status ${recording ? 'recording' : 'disconnected'}`;
            transcriptionStatus.innerHTML = recording ? 'System Running' : 'System Stopped';
            
            document.getElementById('startSystem').disabled = recording;
            document.getElementById('stopSystem').disabled = !recording;
        }
        
        function updateWSStatus(connected) {
            wsStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            wsStatus.textContent = connected ? 'WebSocket Connected' : 'WebSocket Disconnected';
            
            document.getElementById('connectWS').disabled = connected;
            document.getElementById('disconnectWS').disabled = !connected;
            document.getElementById('simulateAudio').disabled = !connected;
        }
        
        // API functions
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/system/status`);
                const data = await response.json();
                log(`Health check: ${data.status}`);
                updateServerStatus(data.status === 'online');
                return data;
            } catch (error) {
                log(`Health check failed: ${error.message}`, 'error');
                updateServerStatus(false);
                return null;
            }
        }
        
        async function getProfiles() {
            try {
                const response = await fetch(`${API_BASE}/system/profiles`);
                const data = await response.json();
                log(`Retrieved ${Object.keys(data.profiles).length} profiles`);
                console.log('Profiles:', data);
                
                // Show profiles in transcription area
                transcriptionDiv.textContent = JSON.stringify(data, null, 2);
                return data;
            } catch (error) {
                log(`Failed to get profiles: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function startSystem() {
            const mode = document.getElementById('modeSelect').value;
            const language = document.getElementById('languageSelect').value;
            const model = document.getElementById('modelSelect').value;
            const vadSensitivity = parseFloat(document.getElementById('vadSensitivity').value);
            const minSpeechDuration = parseFloat(document.getElementById('minSpeechDuration').value);
            const useAdvanced = document.getElementById('useAdvanced').checked;
            
            try {
                // Determine engine type based on model selection
                const isOpenAI = model.includes('gpt-4o');
                const engine = isOpenAI ? 'openai' : 'mlx_whisper';
                
                // Create custom profile configuration
                const customConfig = {
                    transcription: {
                        engine: engine,
                        model: model,
                        language: language || null,
                        auto_start: true
                    },
                    vad: {
                        enabled: true,
                        detector_type: "combined",
                        sensitivity: vadSensitivity,
                        min_speech_duration: minSpeechDuration,
                        window_size: 5
                    }
                };
                
                // Add individual thresholds if advanced mode is enabled
                if (useAdvanced) {
                    customConfig.vad.parameters = {
                        webrtc_aggressiveness: parseInt(document.getElementById('webrtcAggressiveness').value),
                        silero_threshold: parseFloat(document.getElementById('sileroThreshold').value),
                        webrtc_threshold: parseFloat(document.getElementById('webrtcThreshold').value),
                        frame_duration_ms: parseInt(document.getElementById('frameDuration').value),
                        speech_confirmation_frames: parseInt(document.getElementById('speechConfFrames').value),
                        silence_confirmation_frames: parseInt(document.getElementById('silenceConfFrames').value),
                        speech_buffer_size: parseInt(document.getElementById('speechBufferSize').value)
                    };
                }
                
                // Override VAD enabled based on mode
                if (mode === 'continuous') {
                    customConfig.vad.enabled = false;  // No VAD in continuous mode
                } else if (mode === 'wake-word') {
                    // For wake word, include wake word config
                    customConfig.wake_word = {
                        enabled: true,
                        detector: "porcupine",
                        words: ["jarvis"],
                        sensitivity: 0.7,
                        timeout: 30
                    };
                }
                
                const response = await fetch(`${API_BASE}/system/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        profile: mode,
                        custom_config: customConfig
                    })
                });
                const data = await response.json();
                
                if (data.data && data.data.started) {
                    log(`Started system with mode: ${mode}`);
                    updateTranscriptionStatus(true);
                    
                    // Update status with configuration details
                    const statusInfo = document.createElement('div');
                    statusInfo.style.cssText = 'font-size: 0.9em; margin-top: 10px; color: #666;';
                    statusInfo.innerHTML = `
                        <strong>Active Configuration:</strong><br>
                        Mode: ${mode.replace('-', ' ').toUpperCase()}<br>
                        Model: ${model}<br>
                        Language: ${language || 'Auto-detect'}<br>
                        VAD Enabled: ${customConfig.vad.enabled ? 'Yes' : 'No'}<br>
                        ${customConfig.vad.enabled ? `VAD Sensitivity: ${vadSensitivity}<br>Min Speech Duration: ${minSpeechDuration}s<br>` : ''}
                        ${useAdvanced && customConfig.vad.enabled ? `WebRTC Aggressiveness: ${customConfig.vad.parameters.webrtc_aggressiveness}<br>Silero Threshold: ${customConfig.vad.parameters.silero_threshold}<br>` : ''}
                        Active Features: ${data.data.active_features ? data.data.active_features.join(', ') : 'N/A'}
                    `;
                    transcriptionStatus.appendChild(statusInfo);
                    
                    transcriptionDiv.textContent = 'System running - Listening for audio...\n\n';
                    
                    // Auto-connect WebSocket when system starts
                    if (!ws || ws.readyState !== WebSocket.OPEN) {
                        connectWebSocket();
                    }
                } else {
                    log(`Failed to start system: ${data.detail || 'Unknown error'}`, 'error');
                }
                return data;
            } catch (error) {
                log(`Failed to start system: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function stopSystem() {
            try {
                const response = await fetch(`${API_BASE}/system/stop`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                const data = await response.json();
                log('Stopped system');
                updateTranscriptionStatus(false);
                transcriptionDiv.textContent = 'System stopped';
                return data;
            } catch (error) {
                log(`Failed to stop system: ${error.message}`, 'error');
                return null;
            }
        }
        
        // WebSocket functions
        function connectWebSocket() {
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                log('WebSocket connected');
                updateWSStatus(true);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`Received: ${data.event || 'message'}`);
                    
                    // Handle transcription events
                    if (data.event === 'transcription') {
                        if (data.is_final) {
                            // Final transcription
                            transcriptionDiv.textContent += `[${new Date().toLocaleTimeString()}] ${data.text}\n`;
                            transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
                            log(`Transcription: ${data.text}`);
                        } else {
                            // Partial transcription (if applicable)
                            log(`Partial: ${data.text}`);
                        }
                    } else if (data.event === 'wake_word') {
                        log(`Wake word detected: ${data.word}`);
                        transcriptionDiv.textContent += `[Wake Word] ${data.word}\n`;
                    }
                } catch (error) {
                    log(`Failed to parse message: ${error.message}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log('WebSocket error', 'error');
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                log('WebSocket disconnected');
                updateWSStatus(false);
                ws = null;
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function simulateAudio() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket not connected', 'error');
                return;
            }
            
            // Send simulated audio data
            const fakeAudio = new ArrayBuffer(1024);
            ws.send(fakeAudio);
            log('Sent simulated audio chunk');
        }
        
        
        // Update slider labels
        document.getElementById('vadSensitivity').oninput = function() {
            document.getElementById('vadValue').textContent = this.value;
        };
        
        document.getElementById('minSpeechDuration').oninput = function() {
            document.getElementById('speechDurValue').textContent = this.value;
        };
        
        document.getElementById('webrtcAggressiveness').oninput = function() {
            document.getElementById('webrtcValue').textContent = this.value;
        };
        
        document.getElementById('sileroThreshold').oninput = function() {
            document.getElementById('sileroValue').textContent = this.value;
        };
        
        document.getElementById('webrtcThreshold').oninput = function() {
            document.getElementById('webrtcHistValue').textContent = this.value;
        };
        
        document.getElementById('frameDuration').onchange = function() {
            document.getElementById('frameDurValue').textContent = this.value;
        };
        
        document.getElementById('speechConfFrames').oninput = function() {
            document.getElementById('speechConfValue').textContent = this.value;
        };
        
        document.getElementById('silenceConfFrames').oninput = function() {
            document.getElementById('silenceConfValue').textContent = this.value;
        };
        
        document.getElementById('speechBufferSize').oninput = function() {
            document.getElementById('speechBufValue').textContent = this.value;
        };
        
        // Event listeners
        document.getElementById('checkHealth').onclick = checkHealth;
        document.getElementById('getProfiles').onclick = getProfiles;
        document.getElementById('startSystem').onclick = startSystem;
        document.getElementById('stopSystem').onclick = stopSystem;
        document.getElementById('connectWS').onclick = connectWebSocket;
        document.getElementById('disconnectWS').onclick = disconnectWebSocket;
        document.getElementById('simulateAudio').onclick = simulateAudio;
        
        // Initial health check
        checkHealth();
    </script>
</body>
</html>